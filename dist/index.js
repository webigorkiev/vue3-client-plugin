"use strict";exports.__esModule=true;var crypto=require("crypto");var isJS=function(file){return/\.js(\?[^.]+)?$/.test(file)};var isCSS=function(file){return/\.css(\?[^.]+)?$/.test(file)};var uniq=function(arr){return Array.from(new Set(arr))};var hash=function(value){return crypto.createHash("md5").update(value).digest("hex")};var Vue3SSRServerPlugin=function(){function Vue3SSRServerPlugin(options){if(options===void 0){options={}}this.options=Object.assign({filename:"vue-ssr-client-manifest.json"},options)}Vue3SSRServerPlugin.prototype.apply=function(compiler){var _this=this;compiler.hooks.compilation.tap("vue-server-plugin",(function(compilation){compilation.hooks.afterProcessAssets.tap("HelloCompilationPlugin",(function(ass){var stats=compilation.getStats().toJson();stats.assets=stats.assets||[];var allFiles=uniq(stats.assets.map((function(a){return a.name})));stats.entrypoints=stats.entrypoints||{};var entryPointAssets=Object.keys(stats.entrypoints).map((function(name){var _a;return(_a=stats.entrypoints)===null||_a===void 0?void 0:_a[name].assets}));var initialFiles=uniq(entryPointAssets.reduce((function(assets,all){return all.concat(assets)}),[]).filter((function(file){return isJS(file.name)||isCSS(file.name)})).map((function(file){return file.name})));var asyncFiles=allFiles.filter((function(file){return isJS(file)||isCSS(file)})).filter((function(file){return initialFiles.indexOf(file)<0}));var manifest={publicPath:stats.publicPath,all:allFiles,initial:initialFiles,async:asyncFiles,modules:{}};stats.modules=stats.modules||[];var assetModules=stats.modules.filter((function(m){return m.assets.length}));var fileToIndex=function(file){return manifest.all.indexOf(file)};stats.modules.forEach((function(m){var _a;if(m.chunks.length===1){var cid_1=m.chunks[0];var chunk=(_a=stats===null||stats===void 0?void 0:stats.chunks)===null||_a===void 0?void 0:_a.find((function(c){return c.id===cid_1}));if(!chunk||!chunk.files){return}var id=m.identifier.replace(/\s\w+$/,"");var files_1=manifest.modules[hash(id)]=chunk.files.map(fileToIndex);assetModules.forEach((function(m){if(m.chunks.some((function(id){return id===cid_1}))){files_1.push.apply(files_1,m.assets.map(fileToIndex))}}))}}));var json=JSON.stringify(manifest,null,4);var filename=_this.options.filename;compilation.assets[filename]={source:function(){return json},size:function(){return json.length},map:function(){return{}},sourceAndMap:function(){return{source:json,map:{}}},updateHash:function(){},buffer:function(){return Buffer.from(json)}}}))}))};return Vue3SSRServerPlugin}();exports["default"]=Vue3SSRServerPlugin;module.exports=Vue3SSRServerPlugin;